#!/usr/bin/env ruby
# startor

# 20181028
# 0.3.1

# History: Derived from https://kremalicious.com/simple-tor-setup-on-mac-os-x/...

# Prerequisites:
# 1. tor binary is installed.
# 2. Ruby is installed, which it should be already!

# Suggested method for installation of prerequisites:
# 1. Install brew: `/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"`.
# 2. Install tor with brew: `brew install tor`.

# Notes:
# 1. The hardware ports can be any of: 'Thunderbolt Ethernet', 'Thunderbolt Bridge', 'Wi-Fi', 'Ethernet', 'Bluetooth PAN', or 'Display Ethernet'.
# 2. See `networksetup -listallnetworkservices` for the complete list of hardware ports on your machine.

# Changes:
# 1. /require 'IfConfig'/require 'OSX/IfConfig'/
# 2. ~ startor() so that it uses system again, since an interrupt won't be trapped and the proxy won't be brought down.
# 3. ~ main() so that it calls down() instead of going directly to disable_proxy(), since I may want to do more when bringing tor down.
# 4. + green() so that this is easier to read.
# 5. + orange() so that this is easier to read.
# 0/1
# 6. + puts_with_colour().
# 7. /green()/puts_green()/ and call puts_with_colour().
# 8. /orange()/puts_orange()/ and call puts_with_colour().
# 9. Added some installation instructions.

require 'FileUtils/which'
require 'Kernel/run'
require 'OSX/HardwarePort'
require 'OSX/IfConfig'

def check_for_tor_program
  unless FileUtils.which('tor')
    puts 'tor was not found.  Install tor first.'
    exit
  end
end

def enter_admin_password
  system('sudo -v')
end

def active_network_interfaces
  OSX::IfConfig.new.active_interfaces
end

def active_network_ports
  active_network_interfaces.collect do |active_network_interface|
    if hardware_port = OSX::HardwarePort.find_by_device(active_network_interface)
      hardware_port.name
    end
  end.compact
end

def setup_interfaces
  active_network_ports.each do |active_network_port|
    run("sudo networksetup -setsocksfirewallproxy '#{active_network_port}' 127.0.0.1 9050 off", show: true)
  end
end

def puts_with_colour(string, colour)
  system("echo \"$(tput setaf #{colour})\"")
  puts string
  system('echo "$(tput sgr0)"') # color reset
end

def puts_green(string)
  puts_with_colour(string, 64) # Set console text colour to green(ish).
end

def puts_orange(string)
  puts_with_colour(string, 136) # Set console text colour to orange.
end

def enable_proxy
  active_network_ports.each do |active_network_port|
    run("sudo networksetup -setsocksfirewallproxystate '#{active_network_port}' on", show: true)
    puts_green('SOCKS proxy 127.0.0.1:9050 enabled.')
    puts_orange('Starting Tor...')
  end
end

def start_tor
  system('tor')
end

def disable_proxy
  active_network_ports.each do |active_network_port|
    run("sudo networksetup -setsocksfirewallproxystate '#{active_network_port}' off", show: true)
    puts_green('SOCKS proxy disabled.')
  end
end

def up
  check_for_tor_program
  enter_admin_password
  setup_interfaces
  enable_proxy
  start_tor
end

def down
  disable_proxy
end

def main
  case ARGV[0]
  when 'up'; up
  when 'down'; down
  else; up
  end
rescue SystemExit, Interrupt
  down
end

main
